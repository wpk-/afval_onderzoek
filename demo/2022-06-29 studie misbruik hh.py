"""
@FIXME: huishoudens moeten gebruiksdoel woonfunctie hebben.

*** CLUSTER BESTAAT NIET: '119085.048|486252.155' ***
*** CLUSTER BESTAAT NIET: '119436.338|486374.622' ***
*** CLUSTER BESTAAT NIET: '120163.602|486684.195' ***
*** CLUSTER BESTAAT NIET: '116634.340|488127.107' ***
*** CLUSTER BESTAAT NIET: '122217.077|483984.594' ***
*** CLUSTER BESTAAT NIET: '122126.295|484553.423' ***
*** CLUSTER BESTAAT NIET: '122242.144|484109.904' ***
*** CLUSTER BESTAAT NIET: '125278.361|480862.331' ***
*** CLUSTER BESTAAT NIET: '123170.384|487021.757' ***
*** CLUSTER BESTAAT NIET: '122772.017|489319.456' ***
*** CLUSTER BESTAAT NIET: '122854.178|489266.750' ***
*** CLUSTER BESTAAT NIET: '122421.058|489036.017' ***
*** CLUSTER BESTAAT NIET: '123611.205|490419.532' ***

Niet-bestaande adressen:
Centrum, Sarphatistraat 0, , 'Rolf Nilsson B.V.'
Centrum, Singel 0, , 'Haringhandel Frens'
Centrum, Stationsplein 0, , 'NS Stations B.V.'
Centrum, Stationsplein 0, , 'NS VASTGOED B.V.'
Centrum, Amstel 0, , 'Kavalenka'
Centrum, Kalverstraat 59, 1012NZ, 'LEGO Nederland B.V.'
Centrum, Paardenstraat 0, , 'Heere Holding B.V.'
Centrum, Oosterdokskade 200, 1011AE, 'Oosterdokseiland Ontwikkeling Amsterdam C.V.'
Centrum, Keizersgracht 0, , 'Euro Business Centers the Netherlands B.V.'
Centrum, Zeeburgerstraat 0, , 'Azahaf'
Centrum, Spuistraat 0, , 'Yadgari'
Centrum, Spuistraat 0, , 'Yadgari'
Centrum, Prins Hendrikkade 0, , 'Liander N.V.'
Centrum, Westermarkt 0, , 'Sleen'
Centrum,  , , 'GVB Infra B.V.'
Centrum, Entrepotdok 0, , 'Stichting de Alliantie'
Centrum, Geldersekade 28, 1012BJ, 'Pacifica Prosperity Vastgoed B.V.'
Centrum, Nieuwe Uilenburgerstraat 0, , 'J.L. van de Graaf Holding B.V.'
Centrum, Keizersgracht 0, , 'C. Filarski & H. Siepman V.O.F.'
Centrum, Prinsengracht 0, , 'Grefe'
Centrum, Waterlooplein 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Centrum, Waterlooplein 0, , 'Vroome'
Centrum, Waterlooplein 0, , 'Tongeren'
Centrum, Westermarkt 0, , 'Graanstra'
Centrum, Westermarkt 0, , 'Nijhuis'
Centrum, Wittenburgergracht 0, , 'Bloemenhandel Rinus'
Centrum, Herengracht 0, , 'Balvert-van Hoorn V.O.F.'
Centrum, Muntplein 0, , 'Kiosk Monty Grieving'
Centrum, Gravenstraat 0, , 'Protestantse Gemeente te Amsterdam'
Centrum,  , , 'Scherjon'
Centrum, M Centraal Station 0, , 'GVB Infra B.V.'
Centrum, Max Euweplein 61, 1017MA, 'Hard Rock Cafe (Amsterdam) B.V.'
Centrum, Warmoesstraat 87, 1012HZ, 'AA Hostel B.V.'
Centrum, Valckenierstraat 0, , 'Vermeulen'
Centrum, Lijnbaansgracht 379, 1017XC, 'Hal'
Centrum, Geldersekade 20, 1012BH, 'Hotel Geldersekade B.V.'
Centrum, Elleboogsteeg 12, 1012AM, 'Pacifica Prosperity Vastgoed B.V.'
Centrum, Eerste Leliedwarsstraat 7, 1015SZ, 'Aussen'
Nieuw-West, Raasdorperweg 0, , 'Elias'
Nieuw-West, Cort van der Lindenkade 0, , 'Stichting Stadgenoot'
Nieuw-West, Raasdorperweg 0, , 'Geilswijk'
Nieuw-West, Raasdorperweg 0, , 'Stichting Administratiekantoor Vastgoed AMRA'
Nieuw-West, Alma Tademastraat 0, , 'Stichting de Alliantie'
Nieuw-West, Ookmeerweg 0, , 'CBRE DRES Custodian I B.V.'
Nieuw-West, Lakenhalstraat 0, , 'KPN B.V.'
Nieuw-West, Johan Huizingalaan 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Nieuw-West, Descartesstraat 112, 1064ZB, 'Stichting Gouden Paraplu'
Nieuw-West, Jan Lelimanhof 0, , 'Stichting Stadgenoot'
Nieuw-West, Jan Lelimanhof 0, , 'Stichting Stadgenoot'
Nieuw-West, Ruimzicht 0, , 'Cooperatieve Flatexploitatievereniging "Torenwijck V" U.A.'
Nieuw-West, Berlagehof 0, , 'Stichting Stadgenoot'
Nieuw-West, Dijkgraafplein 0, , 'Koopmann'
Nieuw-West, Koningin Wilhelminaplein 0, , 'N. Bloemberg V.O.F.'
Nieuw-West, Koningin Wilhelminaplein 0, , 'Chabane'
Nieuw-West, Koningin Wilhelminaplein 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Nieuw-West, Osdorpplein 0, , 'Thomas'
Nieuw-West, Plesmanlaan 0, , 'Visser'
Nieuw-West, Heining 125, 1047AD, 'Yildirim'
Nieuw-West, Sloterweg 0, , 'Postduivenvereniging "Gevleugelde Vrienden"'
Nieuw-West, Sam van Houtenstraat 1, 1067JA, 'Stichting Eerstelijns Gezondheidszorg Geuzenveld'
Nieuw-West, Sam van Houtenstraat 9, 1067JA, 'Fysiotherapie Sam van Houten'
Nieuw-West, Lakenhalstraat 0, , 'GVB Infra B.V.'
Nieuw-West, Bolstoen 12, 1046AT, 'RVE Projecten 1 B.V.'
Nieuw-West, Jan Voermanstraat 0, , 'Stichting Sint Lucas Andreas Ziekenhuis'
Nieuw-West, Jacob Geelstraat 25, 1065VN, 'Stichting Ara Cora'
Nieuw-West, Jacob Geelstraat 40, 1065VT, 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Nieuw-West, Derkinderenstraat 86, 1062BJ, 'Stichting HIRA'
Nieuw-West, Derkinderenstraat 88, 1062BJ, 'Talent Werving en Selectie B.V.'
Nieuw-West, Descartesstraat 101, 1064ZB, 'Stichting Stadgenoot'
Nieuw-West, Descartesstraat 119, 1064ZB, 'Stichting Gouden Paraplu'
Nieuw-West, Diderotstraat 8, 1064XH, 'Stichting Stadgenoot'
Nieuw-West, Burgemeester De Vlugtln 135, 1063BK, 'Supermarkt Yakhlaf West B.V.'
Nieuw-West, Nicolaas Japiksestraat 20, 1065KG, 'Multiblokken B.V.'
Noord, Zonneplein 19, 1033EJ, 'Gaarenstroom'
Noord, Buiksloterweg 0, , 'Pont Neuf International B.V.'
Noord, Buiksloterweg 0, , 'Stick-Up Indofood'
Noord, Nieuwendammerdijk 0, , 'Rentmeester Hollandia Maatschappij B.V.'
Noord, Slijperweg 0, , 'Deco City Woninginterieur'
Noord, Het Laagt 0, , 'Woningstichting Eigen Haard'
Noord, Walvisvaart 0, , 'Glasvezelnet Amsterdam B.V.'
Noord, NDSM-plein 0, , 'Stichting Kinetisch Noord'
Noord, Broekergouw 0, , 'Zorgboerderij Ons Verlangen B.V.'
Noord, Banne Buikslootlaan 0, , 'Glasvezelnet Amsterdam B.V.'
Noord,  , , 'GVB Infra B.V.'
Noord,  , , 'Low Pressure Studio B.V.'
Noord, IJdoornlaan 0, , 'Tartaud'
Noord, Meeuwenlaan 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Noord, Meeuwenlaan 0, , 'Berkenvelder'
Noord, Statenjachtstraat 0, , 'Langereis'
Noord, Slochterweg 34, 1027AA, 'Shell Nederland Verkoopmaatschappij B.V.'
Noord, Slochterweg 35, 1027AA, 'Stichting International Dispensary Association'
Noord, G.J. Scheurleerpad 6, 1025WM, 'Stichting Proeftuin van Amsterdam'
Noord, Klimopweg 0, , 'Rooms Katholiek Kerkbestuur Van Den Heilige Augustinus Parochie'
Noord, Kamperfoelieweg 211, 1032HM, 'Rooms Katholiek Kerkbestuur Van Den Heilige Augustinus Parochie'
Noord, Plejadenplein 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Noord, Plejadenplein 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Noord, Sleutelbloemstraat 0, , 'Beuken'
Oost, Cruquiusweg 90, 1019AJ, "'Samen tussen Amstel en IJ' Stichting voor Openbaar Primair Onderwijs"
Oost, Solitudolaan 404, 1096DS, 'Heuvel'
Oost, Solitudolaan 412, 1096DS, 'Jong'
Oost, Solitudolaan 412, 1096DS, 'Sonnaville'
Oost, Cruquiusweg 63, 1019AT, 'Mom'
Oost, Wibautstraat 0, , 'ASR Dutch Core Residential Custodian B.V.'
Oost, Solitudolaan 392, 1096DS, 'Leeuwen'
Oost, H.J.E. Wenckebachweg 3012, 1096DP, 'Stichting Cordaan'
Oost, H.J.E. Wenckebachweg 0, , 'Rose'
Oost, H.J.E. Wenckebachweg 0, , 'JAMN V.O.F.'
Oost, Groenhoedenveem 32, 1019BL, 'Maandag Interim Professionals B.V.'
Oost, Cruquiusweg 144, 1019AK, 'AMVEST Woningen-Nova Projectontwikkeling B.V.'
Oost, Insulindeweg 0, , 'Stichting Ymere'
Oost, H.J.E. Wenckebachweg 0, , 'Destil B.V.'
Oost, Zorgwijkstraat 0, , 'Bloemenkiosk Rocco de Cocker'
Oost, Valentijnkade 0, , 'Waterschap Amstel, Gooi en Vecht'
Oost, Veembroederhof 284, 1019HC, 'Tiger of Sweden Netherlands B.V.'
Oost, Joan Muyskenweg 0, , 'GVB Infra B.V.'
Oost, Weesperzijde 0, , 'Aghen B.V.'
Oost, Linnaeushof 0, 1098KH, 'Sportchamps B.V.'
Oost, Molukkenstraat 0, , 'Albert Heijn B.V.'
West, Bos en Lommerweg 114, 1055ED, 'Zwibo B.V.'
West, Jan Pieter Heijestraat 0, , 'Abyssinia Afrikaans Eetcafe'
West, Ten Katestraat 6, 1053CE, 'Leon'
West, Van Hogendorpstraat 0, , 'Janssen'
West, Pontsteiger 0, , 'Krop'
West, Joos Banckersplantsoen 0, , 'Lania'
West, Karel Doormanstraat 103, 1055VD, 'Brewster'
West, Karel Doormanstraat 105, 1055VD, 'Nedcars Autoverhuur B.V.'
West, Karel Doormanstraat 109, 1055VD, 'Taxatierap B.V.'
West, Karel Doormanstraat 99, 1055VD, 'Kijck Makelaars B.V.'
West, De Rijpgracht 12, 1055VS, 'Boei 17 B.V.'
West, Karel Doormanstraat 107, 1055VD, 'Aldeiri en Sandeed'
West, Karel Doormanstraat 111, 1055VE, 'Aldeiri en Sandeed'
West, Piri Reisplein 0, , 'Stichting Stadgenoot'
West, Merlijnstraat 0, , 'Karpa Holding B.V.'
West, Louise de Colignystraat 0, , 'Stichting Ymere'
West, Ten Katestraat 6, 1053CE, 'Leon'
West, Marcantilaan 0, , 'Stichting Ymere'
West, Marcantilaan 0, , 'Stichting Ymere'
West, Bonairestraat 35, 1058XC, 'Matthijssen'
West, Jan van Galenstraat 0, , 'Sandy Bloemen en Planten'
West, Postjesweg 0, , 'J.W. de Keijzer'
West, Leidsebosje 3, 1054LJ, 'Hill'
West, Leidsebosje 1, 1054LJ, 'Balvert Fruitbar V.O.F.'
West, Bos en Lommerplein 170, 1055EK, 'Cooperatieve Rabobank U.A.'
West, Bonaireplein 0, , 'Scholten'
West, Bos en Lommerweg 0, , 'GVB Infra B.V.'
West, Kinkerstraat 0, , 'Blokker B.V.'
Zuid, Apollolaan 0, , 'Siepman'
Zuid, Arent Janszoon Ernststr 0, , 'Firma W. van Slooten'
Zuid, Haarlemmermeerstraat 0, , 'De Zeevang'
Zuid, Wildenborch 0, , 'Fazantenhof Winkels B.V.'
Zuid, Maasstraat 0, , 'Veen Zeebanket'
Zuid, Maasstraat 0, , 'Keulen'
Zuid, Apollolaan 171, 1077AS, 'Jobsites B.V.'
Zuid, Van Leijenberghlaan 140, 1082DC, 'TAKUMI BURGER & LOBSTER BAR'
Zuid, Roelof Hartplein 0, , 'amsterdamflowers.nl'
Zuid, Apollolaan 171, 1077AS, 'Kroonenberg Groep B.V.'
Zuid, Anthony Fokkerweg 0, , 'Amsterdam Anthony Fokkerweg 75 B.V.'
Zuid, Sassenheimstraat 0, , 'Mohamed'
Zuid, Beethovenstraat 0, , 'Bogaers'
Zuid, Fred. Roeskestraat 0, , 'Liander N.V.'
Zuid, Parnassusweg 801, 1082LZ, 'Union Investment Real Estate Gmbh'
Zuid, Apollolaan 171, 1077AS, 'ABN Amro Bank N.V.'
Zuid, Rijnstraat 0, , 'Barlag'
Zuid, Stadionplein 0, 1076CE, 'Arends'
Zuid, Uiterwaardenstraat 0, , 'Daalhuizen'
Zuid, Anthony Fokkerweg 0, , 'Smit'
Zuid, Arent Janszoon Ernststr 0, , 'Ojevaar'
Zuid, Arent Janszoon Ernststr 0, , 'Neervoort'
Zuid, Ferdinand Bolstraat 0, , 'Fragata Ferreira'
Zuid, Emmaplein 0, , 'Horst'
Zuid, Pijnackerstraat 34, 1072JV, 'Aldi Zaandam B.V.'
Zuid, Amstel 0, , 'Smeding'
Zuid, Van Baerlestraat 0, , 'Stichting Bijbelkiosk-Arbeid'
Zuid, Van Woustraat 0, , 'Blankenzee'
Zuid, Willem van Weldammelaan 0, , 'Verburg'
Zuid, Apollolaan 171, 1077AS, 'Mizuho Bank Europe N.V.'
Zuid, President Kennedylaan 13, 1079MB, 'Woningstichting Eigen Haard'
Zuid, Woubruggestraat 0, , 'Provak Amsterdam B.V.'
Zuid, Weerdestein 116, 1083GH, 'Hafkamp Gerechtsdeurwaarders B.V.'
Zuid, P Cornelisz Hooftstr 67, 1071BP, 'Louis Vuitton B.V.'
Zuidoost, Dalsteindreef 0, , 'Syed'
Zuidoost, Nigtevechthof 0, , 'GVB Infra B.V.'
Zuidoost, Ganzenhoef 0, , 'GVB Infra B.V.'
Zuidoost, Seizoenenhof 0, , 'Gemeente Amsterdam Gemeentelijk Vastgoed - Routecode 7196'
Zuidoost, Kromwijkdreef 13, 1108JA, 'Groengebied Amstelland'
Zuidoost, 1e Kekerstraat 0, , 'KPN B.V.'
Zuidoost, Markelerbergpad 1, 1105AW, 'Jumbo Supermarkten B.V.'
Zuidoost, Bijlmerplein 0, , 'Q-Park Operations Netherlands B.V.'
 Geen stadsdeel bekend op zoekdatum, Beethovenstraat 0, , 'Bogaers'
 Geen stadsdeel bekend op zoekdatum, Sloterweg 0, , 'Bond van Volkstuinders'
 Geen stadsdeel bekend op zoekdatum,  , , 'Stichting Nederlands Scheepvaartmuseum Amsterdam'
 Geen stadsdeel bekend op zoekdatum, Vlaardingenlaan 0, , 'GVB Infra B.V.'
 Geen stadsdeel bekend op zoekdatum, Maassluisstraat 0, , 'GVB Infra B.V.'
Onbekend, Van Riebeeckhavenweg 0, , 'Waterschap Amstel, Gooi en Vecht'
Onbekend, Petroleumhavenweg 0, , 'Alkion Terminal Amsterdam B.V.'
Onbekend, Radarweg 0, , 'Shell Nederland B.V.'
Onbekend,  , , 'Evos Amsterdam East B.V.'
Onbekend, Nieuwe Hemweg 0, , 'KPN B.V.'
Onbekend, Nieuwe Hemweg 0, , 'Tick'
Onbekend, Ankerweg 0, , 'CTP ALC B.V.'

Container query:
SELECT "id","idNummer","serienummer","clusterId","eigenaarId","eigenaarNaam",
       "status","fractieCode","fractieOmschrijving","datumCreatie",
       "datumPlaatsing","datumOperationeel","datumAflopenGarantie",
       "datumOplevering","wijzigingsdatumDp","verwijderdDp","geadopteerdInd",
       "locatieId","geometrie","typeId","bagHoofdadresVerblijfsobjectId",
       "gbdBuurtId","bagOpenbareruimteId","bagNummeraanduidingId",
       "containerRalKleurNaam","containerRalKleurCode",
       "containerRalKleurHexcode","containerChipNummber",
       "containerUnitCardLezerId","containerKleur","containerMark",
       "containerDatumVervanging","containerDatumWijziging",
       "containerEndOfLife","containerEigenaarschap",
       "containerEigenaarschapOpmerking","containerOpmerking"
FROM "public"."v1_huishoudelijkafval_container"
WHERE "_created" < '2022-03-07'
AND ("_deleted" > '2022-03-07' OR "_deleted" IS NULL)
AND "status" = '1'
AND "fractieOmschrijving" = 'Rest'
AND "geometrie" IS NOT NULL

"""
import csv
import logging
from collections import defaultdict, Counter
from collections.abc import Callable
from datetime import date
from typing import NamedTuple

import aapi
import numpy as np
from aapi.csv import (
    WegingenCsv, ContainersCsv, LigplaatsenCsv, NummeraanduidingenCsv,
    StandplaatsenCsv, VerblijfsobjectenCsv
)
from aapi.models import (
    Afvalcontainer, Afvalweging, Ligplaats, Nummeraanduiding, Standplaats,
    Verblijfsobject
)

from afval.graaf import kortste_afstand, G, KDGraaf, dichtstbijzijnde_doel, \
    herverdeel_hemelsbreed
from afval.io import lees_reinigingsrecht
from afval.osm import amsterdam
from afval.types import AfstandIndex
from demo.adressen_per_container import Stacked
from demo.loopafstanden import cached_amsterdam

api = aapi.API()

datum_van = '2022-01-10'
datum_tot = '2022-03-07'

max_afstand: float = 150.

containers = ContainersCsv(
    f'cache/Containers met status-1 {datum_van}.csv',
    {
        'status': '1',
        'geometrie[isnull]': 'false',
    }
)

wegingen = WegingenCsv(
    f'cache/Wegingen {datum_van} tot {datum_tot}.csv',
    {
        'datumWeging[gte]': datum_van,
        'datumWeging[lt]': datum_tot,
        'geometrie[isnull]': 'false',
    }
)


class Info(NamedTuple):
    locatie: str                            # 'Javastraat'
    categorie: str                          # 'woon' / 'winkel'
    adres: str                              # 'Javastraat 102'
    cluster: str                            # '124307.118|486297.137'
    aantal_objecten: int                    # ...
    aantal_huishoudens: int                 # 88
    aantal_reinigingsrecht_vol: int         # ...
    aantal_reinigingsrecht_half: int        # ...
    reinigingsrecht_gewicht_per_dag: float  # 112.95
    containers: str                         # 'REM16599,REM16800'
    aantal_containers: int                  # 3
    inzameldagen: str                       # 'ma,wo,vr'
    datum: date                             # 12-1-2022
    dag: str                                # 'wo'
    aantal_dagen: int                       # 3
    wegingen: str                           # '320,245,24'
    aantal_wegingen: int                    # 2
    som_wegingen: float                     # 565
    cluster_gewicht: float                  # 847.5    (=565/2 * 3)
    cluster_gewicht_per_dag: float          # 423.75

    @staticmethod
    def header() -> tuple[str, ...]:
        return (
            'Locatie', 'Categorie', 'Adres', 'Cluster', 'Aantal objecten',
            'Aantal huishoudens', 'Reinigingsrecht VOL', 'Reinigingsrecht HLF',
            'Reinigingsrecht gewicht (kg/dag)', 'Containers',
            'Aantal containers', 'Inzameldagen', 'Datum', 'Dag',
            'Aantal dagen', 'Wegingen', 'Aantal wegingen', 'Som wegingen',
            'Cluster gewicht', 'Cluster gewicht (kg/dag)',
        )


# containers = ContainersCsv(
#     'cache/Containers rest 2022-03-07.csv',
#     {
#         'status': '1',
#         'fractieOmschrijving': 'Rest',
#         'geometrie[isnull]': 'false',
#     }
# )


objecten = Stacked(
    VerblijfsobjectenCsv(
        'cache/Verblijfsobjecten met status-347 2022-06-23.csv',
        {
            'statusCode[in]': '3,4,7',
        },
    ),
    LigplaatsenCsv(
        'cache/Ligplaatsen met status-1 2022-06-23.csv',
        {
            'statusCode': '1',
        },
    ),
    StandplaatsenCsv(
        'cache/Standplaatsen met status-1 2022-06-23.csv',
        {
            'statusCode': '1',
        },
    ),
)

woningen = Stacked(
    VerblijfsobjectenCsv(
        'cache/Verblijfsobjecten met woonfunctie status-347 2022-07-14.csv',
        {
            'gebruiksdoel.omschrijving[in]': 'woonfunctie,Woonfunctie',
            'statusCode[in]': '3,4,7',
        },
    ),
    LigplaatsenCsv(
        'cache/Ligplaatsen met woonfunctie status-1 2022-07-14.csv',
        {
            'gebruiksdoel.omschrijving[in]': 'woonfunctie,Woonfunctie',
            'statusCode': '1',
        },
    ),
    StandplaatsenCsv(
        'cache/Standplaatsen met woonfunctie status-1 2022-07-14.csv',
        {
            'gebruiksdoel.omschrijving[in]': 'woonfunctie,Woonfunctie',
            'statusCode': '1',
        },
    ),
)

huisnummers = NummeraanduidingenCsv(
    'cache/Nummeraanduidingen 2022-06-23.csv',
    {
        # 'statusCode': '1',
    },
)


class LoopDoorAmsterdam:
    def __init__(self, naar: np.ndarray, knip_lengte: float = 3.) -> None:
        wegen = (
            cached_amsterdam(knip_lengte, fietspaden=fp, voetpaden=vp)
            for fp, vp in ((False, False), (False, True), (True, False),
                           (True, True))
        )
        wegen = tuple((KDGraaf.van_graaf(g), ll) for g, ll in wegen)

        self.doelen = np.atleast_2d(naar)
        self.layers = [(g, ll, dichtstbijzijnde_doel(g, naar, ll))
                       for g, ll in wegen]

    def afstand(self, van: np.ndarray, herverdeel_onder: float = None
                ) -> tuple[np.ndarray, np.ndarray]:
        n = van.shape[0]
        afstand = np.inf * np.ones(n, dtype=float)
        index = np.zeros(n, dtype=int)

        for i, (g, ll, naar) in enumerate(self.layers):
            d, ix = kortste_afstand(g, van, naar, ll)

            if herverdeel_onder:
                d, ix = herverdeel_hemelsbreed((d, ix), van, self.doelen,
                                               max_onderling=herverdeel_onder)

            if i == 0:
                afstand = d
                index = ix
            else:
                ii = d < afstand
                afstand[ii] = d[ii]
                index[ii] = ix[ii]

        return AfstandIndex((afstand, index))


def containers_adder(cluster_containers: dict[str, list[Afvalcontainer]]
                     ) -> Callable[[Info], Info]:
    def adder(info: Info) -> Info:
        cc = cluster_containers[info.cluster]
        return info._replace(
            containers=','.join(c.idNummer for c in cc),
            aantal_containers=len(cc),
        )
    return adder


def nog_korter(kaarten: list[tuple[G, np.ndarray]],
               van: np.ndarray, naar: np.ndarray
               ) -> tuple[np.ndarray, np.ndarray]:
    """Berekent de allerkortste loopafstand van a naar b.
    """
    n = van.shape[0]
    afstand = np.inf * np.ones(n, dtype=float)
    index = np.zeros(n, dtype=int)

    for i, (kaart, ll) in enumerate(kaarten):
        d, ix = kortste_afstand(kaart, van, naar, ll)

        if i == 0:
            afstand = d
            index = ix
        else:
            ii = d < afstand
            afstand[ii] = d[ii]
            index[ii] = ix[ii]

    return AfstandIndex((afstand, index))


def data():
    def object_id(obj: Verblijfsobject | Ligplaats | Standplaats) -> str:
        return obj.id.split('.')[0]

    def nummer_pcxy(num: Nummeraanduiding
                    ) -> tuple[tuple[str, int], tuple[float, float]]:
        pc = num.postcode, num.huisnummer
        oid = (num.adresseertVerblijfsobjectId or num.adresseertLigplaatsId or
               num.adresseertStandplaatsId)
        return pc, object_xy.get(oid, None)

    print('cluster ID -> [container, ...]')
    cluster_containers = defaultdict(list)
    for container in containers:
        if container.fractieOmschrijving == 'Rest' and container.geometrie:
            cluster_containers[container.clusterId].append(container)
    cluster_containers = dict(cluster_containers)

    print('cluster ID -> (x, y)')
    cluster_xy = {cid: np.mean([c.geometrie for c in cc], axis=0)
                  for cid, cc in cluster_containers.items()}
    cluster_id = list(cluster_xy.keys())
    np_cluster_xy = np.array(list(cluster_xy.values()))

    print('graaf + afstand naar containers')
    loop = LoopDoorAmsterdam(naar=np_cluster_xy)
    # kaarten = [cached_amsterdam(knip_lengte=3.0, fietspaden=fp, voetpaden=vp)
    #            for fp, vp in ((False, False), (False, True), (True, False),
    #                           (True, True))]
    # kaart, ll = amsterdam(knip_lengte=3.0)

    print('object ID -> (x, y)')
    object_xy = {
        object_id(hh): hh.geometrie
        for hh in objecten
        if hh.geometrie
    }
    np_object_xy = np.array(list(object_xy.values()))

    print('woning ID -> (x, y)   = object ID met woonfunctie')
    woning_xy = {
        object_id(hh): hh.geometrie
        for hh in woningen
        if hh.geometrie
    }
    np_woning_xy = np.array(list(woning_xy.values()))

    print('(postcode. huisnummer) -> (x, y)')
    postcode_xy = {
        pc: xy
        for pc, xy in (nummer_pcxy(num) for num in huisnummers)
        if xy
    }

    print('[(x, y), ...]')
    rein = lees_reinigingsrecht('in/2022-03-28 Reinigingsrecht week 13.xlsx')
    for rr in rein:
        if rr.reintarcode and (rr.postcode, rr.huisnr) not in postcode_xy:
            print(f'*** ADRES BESTAAT NIET: {rr.stadsdeel},'
                  f' {rr.straat} {rr.huisnr}, {rr.postcode}, {rr.naam!r} ***')
    np_rein_vol_xy = np.array([
        postcode_xy[(rr.postcode, rr.huisnr)]
        for rr in rein
        if rr.reintarcode == 'VOL'
        and not (rr.uitsluitcode or rr.contractletter)
        and (rr.postcode, rr.huisnr) in postcode_xy
    ])
    np_rein_hlf_xy = np.array([
        postcode_xy[(rr.postcode, rr.huisnr)]
        for rr in rein
        if rr.reintarcode == 'HLF'
        and (rr.postcode, rr.huisnr) in postcode_xy
    ])

    print('cluster ID -> aantal objecten')
    # afstand, index = nog_korter(kaarten, np_object_xy, np_cluster_xy)
    afstand, index = loop.afstand(np_object_xy, herverdeel_onder=25.)
    cluster_aantal_objecten = Counter(
        cluster_id[i]
        for d, i in zip(afstand, index)
        if d <= max_afstand
    )

    print('cluster ID -> aantal huishoudens')
    # afstand, index = nog_korter(kaarten, np_woning_xy, np_cluster_xy)
    afstand, index = loop.afstand(np_woning_xy, herverdeel_onder=25.)
    cluster_aantal_huishoudens = Counter(
        cluster_id[i]
        for d, i in zip(afstand, index)
        if d <= max_afstand
    )

    print('cluster ID -> aantal reinigingsrecht')
    # afstand, index = nog_korter(kaarten, np_rein_vol_xy, np_cluster_xy)
    afstand, index = loop.afstand(np_rein_vol_xy, herverdeel_onder=25.)
    cluster_aantal_rein_vol = Counter(
        cluster_id[i]
        for d, i in zip(afstand, index)
        if d <= max_afstand
    )
    # afstand, index = nog_korter(kaarten, np_rein_hlf_xy, np_cluster_xy)
    afstand, index = loop.afstand(np_rein_hlf_xy, herverdeel_onder=25.)
    cluster_aantal_rein_hlf = Counter(
        cluster_id[i]
        for d, i in zip(afstand, index)
        if d <= max_afstand
    )

    for cid in cluster_id:
        yield (
            cid,
            cluster_aantal_objecten[cid],
            cluster_aantal_huishoudens[cid],
            cluster_aantal_rein_vol[cid],
            cluster_aantal_rein_hlf[cid],
        )
    # for cid in clusters:
    #     if cid not in cluster_containers:
    #         print(f'*** CLUSTER BESTAAT NIET: {cid!r} ***')
    #         continue
    #     s_containers = ','.join(c.idNummer for c in cluster_containers[cid])
    #     n_containers = len(cluster_containers[cid])
    #     n_objecten = cluster_aantal_objecten[cid]
    #     n_huishoudens = cluster_aantal_huishoudens[cid]
    #     n_rein_vol = cluster_aantal_rein_vol[cid]
    #     n_rein_hlf = cluster_aantal_rein_hlf[cid]
    #
    #     wegingen = api.afval_wegingen(**{
    #         'clusterId': cid,
    #         'datumWeging[gte]': datum_van,
    #         'datumWeging[lt]': datum_tot,
    #         'fractieOmschrijving': 'Rest',
    #         '_sort': 'datumWeging,tijdstipWeging',
    #     })
    #
    #     # datum -> [weging, ...]
    #     datum_wegingen: dict[date, list[Afvalweging]] = defaultdict(list)
    #     for w in wegingen:
    #         datum_wegingen[w.datumWeging].append(w)
    #
    #     for dt, ww in datum_wegingen.items():
    #         s_dag = ['ma', 'di', 'wo', 'do', 'vr', 'za', 'zo'][dt.weekday()]
    #         s_wegingen = ','.join(str(w.nettoGewicht) for w in ww)
    #         s_wegingen = f'"{s_wegingen}"'
    #         n_wegingen = len(ww)
    #         t_wegingen = sum(w.nettoGewicht for w in ww)
    #
    #         yield Info(
    #             '', '', '', cid, n_objecten, n_huishoudens, n_rein_vol,
    #             n_rein_hlf, 0, s_containers, n_containers, '', dt, s_dag, 0,
    #             s_wegingen, n_wegingen, t_wegingen, 0, 0
    #         )


def main():
    # studie = 'Mosveld'
    # clusters = [cid
    #             for locatie, categorie, cluster_ids in clusters
    #             for cid in cluster_ids
    #             if locatie == studie]
    # datum_van = '2022-01-10'
    # datum_tot = '2022-03-07'
    # max_afstand = 150.
    file_out = f'out/2022-06-29 studie misbruik hh - aantallen per cluster.csv'

    with open(file_out, 'w', newline='', encoding='utf-8') as f:
        writer = csv.writer(f, quotechar='"', delimiter=',')
        # writer.writerow(Info.header())
        # writer.writerows(data(clusters, datum_van, datum_tot, max_afstand))
        writer.writerow((
            'Cluster', 'Aantal objecten', 'Aantal huishoudens',
            'Aantal Reinigingsrecht VOL', 'Aantal reinigingsrecht HLF'))
        writer.writerows(data())


if __name__ == '__main__':
    logging.basicConfig(level=logging.DEBUG)
    # logging.getLogger('urllib3').setLevel(logging.WARNING)
    main()
